
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // USER PROFILES
    // Users can create their own profile, and read/update it.
    // Admins can read/write any profile.
    match /users/{userId} {
      allow create, read, update: if request.auth.uid == userId;
      allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ATTENDANCE
    // Students can create their own attendance records but not view others'.
    // Teachers and Admins can list all attendance.
    match /attendance/{attendanceId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      allow read: if request.auth.uid == resource.data.userId;
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['teacher', 'admin'];
    }

    // ANNOUNCEMENTS
    // Authenticated users can read announcements.
    // Only teachers/admins can create/update/delete them.
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['teacher', 'admin'];
    }

    // ASSIGNMENTS
    // Authenticated users can read assignments.
    // Only teachers/admins can create/update/delete them.
    match /assignments/{assignmentId} {
      allow read: if request.auth != null;
      allow create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['teacher', 'admin'];
    }

    // SUBMISSIONS
    // Students can create/update/read their own submission.
    // Teachers can list/read/update all submissions for an assignment.
    match /assignments/{assignmentId}/submissions/{studentId} {
      allow read, create, update: if request.auth.uid == studentId;
      allow list, read, update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // CHAT HISTORY
    // Chat sessions are private to each user.
    match /chats/{chatId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      allow read, list: if request.auth.uid == resource.data.userId;
    }
    
    // LIVE CLASSES
    // Authenticated users can read live class status.
    // Only teachers can write/update the live class document.
    match /liveClasses/{classId} {
      allow read: if request.auth != null;
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // RECORDED LECTURES
    // Authenticated users can read recorded lectures.
    // Only teachers can create them.
    match /recordedLectures/{lectureId} {
      allow read: if request.auth != null;
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
  }
}
